<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI营养师小程序 - 完整原型展示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .phone-frame {
            width: 393px;
            height: 852px;
            background: #000;
            border-radius: 47px;
            padding: 8px;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
            position: relative;
        }
        .phone-frame:hover {
            transform: scale(1.02);
        }
        .screen {
            width: 100%;
            height: 100%;
            background: #fff;
            border-radius: 39px;
            overflow: hidden;
            position: relative;
        }
        .prototype-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 40px;
            padding: 40px;
            background: #F2F2F2;
        }
        .prototype-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .prototype-title {
            font-size: 18px;
            font-weight: 600;
            color: #181818;
            margin-bottom: 20px;
            text-align: center;
        }
        .category-section {
            margin-bottom: 60px;
        }
        .category-title {
            font-size: 28px;
            font-weight: 700;
            color: #181818;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }
        .category-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: #C3EB2E;
            border-radius: 2px;
        }
        .category-description {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 12px 24px;
            background: white;
            border-radius: 25px;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .nav-tab.active {
            background: #C3EB2E;
            color: #181818;
            border-color: #C3EB2E;
        }
        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .section-content {
            display: none;
        }
        .section-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        .section-content.fade-in { animation: fadeIn .18s ease-out; }
        .page-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #C3EB2E;
            color: #181818;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .flow-arrow {
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            color: #C3EB2E;
            font-size: 24px;
            z-index: 10;
        }
        .flow-line {
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 2px;
            background: #C3EB2E;
        }
        .page-level {
            position: absolute;
            top: -15px;
            left: -15px;
            background: #ff6b6b;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }
        .page-level.secondary {
            background: #4ecdc4;
        }
        .page-level.tertiary {
            background: #ffa726;
        }
        .interaction-hint {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .prototype-item:hover .interaction-hint {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- 页面标题 -->
    <div class="text-center py-12 bg-white shadow-sm">
        <h1 class="text-4xl font-bold" style="color: #181818;">AI营养师小程序</h1>
        <p class="text-lg" style="color: #181818;">完整功能原型展示 - 支持页面间跳转</p>
    </div>

    <!-- 导航标签 -->
    <div class="nav-tabs">
        <div class="nav-tab active" data-target="main-flow" onclick="showSection('main-flow', this)">主要流程</div>
        <div class="nav-tab" data-target="records-flow" onclick="showSection('records-flow', this)">记录管理</div>
        <div class="nav-tab" data-target="goals-flow" onclick="showSection('goals-flow', this)">目标管理</div>
        <div class="nav-tab" data-target="profile-flow" onclick="showSection('profile-flow', this)">个人中心</div>
    </div>

    <!-- 主要流程 -->
    <div id="main-flow" class="section-content active">
        <div class="category-section">
            <h2 class="category-title">主要用户流程</h2>
            <p class="category-description">展示用户从首页到各个功能模块的完整交互流程</p>
            <div class="prototype-grid">
                <!-- 首页 -->
                <div class="prototype-item">
                    <div class="page-level">首页</div>
                    <h3 class="prototype-title">今日 - 健康概览</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="home.html?v=20251030" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                    <div class="interaction-hint">点击打卡记录或健康统计进入详情</div>
                </div>

                <!-- 目标进度 -->
                <div class="prototype-item">
                    <div class="page-level">一级</div>
                    <h3 class="prototype-title">目标 - 进度追踪</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="progress.html" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                    <div class="interaction-hint">点击设置按钮进入目标设置</div>
                </div>

                <!-- 个人档案 -->
                <div class="prototype-item">
                    <div class="page-level">一级</div>
                    <h3 class="prototype-title">我的 - 个人档案</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="profile.html" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                    <div class="interaction-hint">点击功能项进入详情页面</div>
                </div>

            </div>
        </div>
    </div>

    <!-- 记录管理流程 -->
    <div id="records-flow" class="section-content">
        <div class="category-section">
            <h2 class="category-title">记录管理流程</h2>
            <p class="category-description">从首页打卡记录到健康记录的完整流程</p>
            <div class="prototype-grid">
                <!-- 首页 -->
                <div class="prototype-item">
                    <div class="page-level">首页</div>
                    <h3 class="prototype-title">今日 - 健康概览</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="home.html?v=20251030" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                    <div class="flow-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>

                <!-- 健康记录 -->
                <div class="prototype-item">
                    <div class="page-level secondary">二级</div>
                    <h3 class="prototype-title">健康记录</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="records.html" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 目标管理流程 -->
    <div id="goals-flow" class="section-content">
        <div class="category-section">
            <h2 class="category-title">目标管理流程</h2>
            <p class="category-description">从目标管理到设置和方案的完整流程</p>
            <div class="prototype-grid">
                <!-- 目标进度页面 -->
                <div class="prototype-item">
                    <div class="page-level">一级</div>
                    <h3 class="prototype-title">目标 - 进度追踪</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="progress.html" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                    <div class="flow-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>

                <!-- 目标设置 -->
                <div class="prototype-item">
                    <div class="page-level secondary">二级</div>
                    <h3 class="prototype-title">目标设置</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="goal-setting.html" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 个人中心流程 -->
    <div id="profile-flow" class="section-content">
        <div class="category-section">
            <h2 class="category-title">个人中心流程</h2>
            <p class="category-description">从个人档案到各项功能设置的完整流程</p>
            <div class="prototype-grid">
                <!-- 个人档案主页面 -->
                <div class="prototype-item">
                    <div class="page-level">一级</div>
                    <h3 class="prototype-title">我的 - 个人档案</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="profile.html" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                    <div class="flow-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>

                <!-- 我的AI营养师 -->
                <div class="prototype-item">
                    <div class="page-level secondary">二级</div>
                    <h3 class="prototype-title">我的AI营养师</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="nutritionist.html" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>

                <!-- 我的健康方案 -->
                <div class="prototype-item">
                    <div class="page-level secondary">二级</div>
                    <h3 class="prototype-title">我的健康方案</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="weight-loss-plan.html" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>


                <!-- 健康档案 -->
                <div class="prototype-item">
                    <div class="page-level secondary">二级</div>
                    <h3 class="prototype-title">健康档案</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="health-profile.html" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>


                <!-- 个人账号信息 -->
                <div class="prototype-item">
                    <div class="page-level secondary">二级</div>
                    <h3 class="prototype-title">个人账号信息</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="account.html" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>

                <!-- 认证（登录/注册合一） -->
                <div class="prototype-item">
                    <div class="page-level secondary">二级</div>
                    <h3 class="prototype-title">认证（登录/注册）</h3>
                    <div class="phone-frame">
                        <div class="screen">
                            <iframe src="auth.html" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- 交互流程图（自动生成） -->
    <div class="text-center py-12 bg-white mt-12">
        <h2 class="text-3xl font-bold" style="color: #181818;">页面交互流程图</h2>
        <div class="max-w-6xl mx-auto px-4">
            <div class="bg-gray-50 rounded-2xl p-8">
                <div id="flow-legend" class="text-sm text-left max-w-3xl mx-auto mb-6 text-gray-600"></div>
                <div id="flow-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </div>
        </div>
    </div>

    <!-- 页面统计 -->
    <div class="text-center py-8 bg-white mt-12">
        <div class="grid grid-cols-4 gap-8 max-w-4xl mx-auto">
            <div>
                <div class="text-3xl font-bold" style="color: #181818;">8</div>
                <div style="color: #181818;">总页面数</div>
            </div>
            <div>
                <div class="text-3xl font-bold" style="color: #C3EB2E;">4</div>
                <div style="color: #181818;">功能模块</div>
            </div>
            <div>
                <div class="text-3xl font-bold" style="color: #C3EB2E;">完整</div>
                <div style="color: #181818;">交互流程</div>
            </div>
            <div>
                <div class="text-3xl font-bold" style="color: #C3EB2E;">100%</div>
                <div style="color: #181818;">功能覆盖</div>
            </div>
        </div>
    </div>

    <script>
        function showSection(sectionId, clickedTab) {
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active', 'fade-in');
            });
            const next = document.getElementById(sectionId);
            if (next) {
                next.classList.add('active');
                requestAnimationFrame(() => next.classList.add('fade-in'));
            }

            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            if (clickedTab) {
                clickedTab.classList.add('active');
            } else {
                const tab = document.querySelector(`.nav-tab[data-target="${sectionId}"]`);
                if (tab) tab.classList.add('active');
            }
            try { localStorage.setItem('lastSectionId', sectionId); } catch(e) {}
        }

        // 添加页面跳转模拟功能
        function simulateNavigation(fromPage, toPage) {
            console.log(`从 ${fromPage} 跳转到 ${toPage}`);
        }

        // 刷新后保持在上一次的Section，并恢复各iframe最后的页面
        document.addEventListener('DOMContentLoaded', function() {
            // 恢复上次的Section
            const last = localStorage.getItem('lastSectionId') || 'main-flow';
            showSection(last);

            // 为每个iframe恢复并监听当前地址（带版本参数的默认src不被旧缓存覆盖）
            const frames = document.querySelectorAll('.screen iframe');
            let saveTimer = null;
            frames.forEach((frame) => {
                const defaultSrc = frame.getAttribute('src') || '';
                const [defaultBase, defaultQuery = ''] = defaultSrc.split('?');
                // 新键规则：按基础路径存储，避免版本参数变化导致读取不到
                const key = `iframeState:${defaultBase}`;

                // 兼容旧键：清理含查询参数的历史键，防止错误覆盖
                try { localStorage.removeItem(`iframeState:${defaultSrc}`); } catch(e) {}

                const saved = localStorage.getItem(key);
                if (saved && saved !== defaultSrc) {
                    const [savedBase] = saved.split('?');
                    const hasVersion = /[?&]v=/.test(defaultQuery);
                    const savedHasVersion = /[?&]v=/.test(saved);

                    // 只在同一基础页面时才恢复；否则保持默认（例如 home 不被 records 覆盖）
                    if (savedBase === defaultBase) {
                        // 若默认包含版本但缓存不含版本，避免旧缓存把版本去掉
                        if (hasVersion && !savedHasVersion) {
                            frame.setAttribute('src', defaultSrc);
                        } else {
                            frame.setAttribute('src', saved);
                        }
                    } else {
                        try { localStorage.removeItem(key); } catch(e) {}
                        frame.setAttribute('src', defaultSrc);
                    }
                }

                frame.addEventListener('load', () => {
                    try {
                        const currentHref = frame.contentWindow.location.href;
                        const [currentBase] = currentHref.split('?');
                        // 简单节流，避免频繁写入
                        if (saveTimer) cancelAnimationFrame(saveTimer);
                        saveTimer = requestAnimationFrame(() => {
                            // 仅当仍在同一基础页面时保存，避免把其它页面持久化到此卡槽
                            if (currentBase === defaultBase) {
                                localStorage.setItem(key, currentHref);
                            }
                        });
                        // 请求该 iframe 页面上报可达链接
                        frame.contentWindow.postMessage({ type: '__REQUEST_FLOW__' }, '*');
                    } catch (e) { /* 忽略跨域 */ }
                });
            });

            // 自动收集与渲染交互流程图
            initAutoFlow(frames);
        });

        // ============ 自动流程图渲染 ============
        function initAutoFlow(frames) {
            const container = document.getElementById('flow-container');
            const legend = document.getElementById('flow-legend');
            const pageToModule = inferModuleByPageName;
            const graph = new Map(); // from -> Set(to)
            const pageTitles = new Map(); // filename -> title

            // 从 iframe 的 src 推断标题（取 h3.prototype-title 文本）
            try {
                document.querySelectorAll('.prototype-item').forEach((item)=>{
                    const iframe = item.querySelector('iframe');
                    const title = item.querySelector('.prototype-title')?.textContent?.trim();
                    if (iframe && title) {
                        const src = (iframe.getAttribute('src')||'').trim();
                        if (src) pageTitles.set(src.split('?')[0], title);
                    }
                });
            } catch(e) {}

            // 监听子页面上报
            window.addEventListener('message', function(evt){
                const data = evt && evt.data;
                if (!data || data.type !== '__FLOW_LINKS__') return;
                const from = (data.from || '').split('?')[0];
                if (!from) return;
                const links = Array.isArray(data.links) ? data.links : [];
                if (!graph.has(from)) graph.set(from, new Set());
                const set = graph.get(from);
                links.forEach((to)=>{ if (to) set.add(to.split('?')[0]); });
                scheduleRender();
            });

            // 初始向所有 iframe 请求一次
            try { frames.forEach(f=>{ f.contentWindow && f.contentWindow.postMessage({ type: '__REQUEST_FLOW__' }, '*'); }); } catch(e) {}

            let renderTimer = null;
            function scheduleRender(){
                if (renderTimer) cancelAnimationFrame(renderTimer);
                renderTimer = requestAnimationFrame(render);
            }

            function render(){
                const sections = groupByModule(graph);
                // 图例
                if (legend) legend.innerHTML = '根据各页面的 data-link、a[href]、onclick 跳转自动汇总。修改页面后刷新即可更新。';

                if (!container) return;
                container.innerHTML = '';
                Object.keys(sections).forEach((moduleName)=>{
                    const list = sections[moduleName];
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl p-6 shadow-sm text-left';
                    const h = document.createElement('h3');
                    h.className = 'text-lg font-bold';
                    h.style.color = '#181818';
                    h.textContent = moduleName;
                    const body = document.createElement('div');
                    body.className = 'space-y-2 text-sm';
                    body.style.color = '#181818';

                    list.forEach(({ from, to })=>{
                        const fromLabel = pageTitles.get(from) || labelFromFilename(from);
                        const toLabel = pageTitles.get(to) || labelFromFilename(to);
                        const row = document.createElement('div');
                        row.textContent = `${fromLabel} → ${toLabel}`;
                        body.appendChild(row);
                    });

                    card.appendChild(h);
                    card.appendChild(body);
                    container.appendChild(card);
                });
            }

            function groupByModule(g){
                const out = {};
                g.forEach((tos, from)=>{
                    tos.forEach((to)=>{
                        const key = pageToModule(from, to);
                        if (!out[key]) out[key] = [];
                        out[key].push({ from, to });
                    });
                });
                return out;
            }

            function labelFromFilename(name){
                const base = (name || '').split('/').pop().replace('.html','');
                const map = {
                    'home': '首页', 'profile': '个人档案', 'progress': '目标管理', 'records': '健康记录',
                    'goal-setting': '目标设置', 'nutritionist': '我的AI营养师',
                    'weight-loss-plan': '我的健康方案', 'health-profile': '健康档案',
                    'account': '个人账号信息', 'auth': '认证'
                };
                return map[base] || base;
            }

            function inferModuleByPageName(from, to){
                const all = from + '|' + to;
                if (/home\.html/.test(all)) return '主要流程';
                if (/records\.html/.test(all)) return '记录管理';
                if (/progress\.html|goal-setting\.html/.test(all)) return '目标管理';
                if (/profile\.html|nutritionist\.html|weight-loss-plan\.html|health-profile\.html|account\.html|auth\.html/.test(all)) return '个人中心';
                return '其它';
            }
        }
    </script>
</body>
</html> 
